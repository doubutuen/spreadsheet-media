---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { 
  getTags, 
  getTagBySlug, 
  getArticlesByTag,
  getCategories,
  getAuthors
} from '../../lib/spreadsheet';

// 静的パスを生成
export async function getStaticPaths() {
  const tags = await getTags();
  return tags.map((tag) => ({
    params: { slug: tag.slug },
  }));
}

const { slug } = Astro.params;
const tag = await getTagBySlug(slug as string);

if (!tag) {
  return Astro.redirect('/404');
}

const articles = await getArticlesByTag(tag.id);
const categories = await getCategories();
const authors = await getAuthors();
const categoryMap = new Map(categories.map(c => [c.id, c]));
const authorMap = new Map(authors.map(a => [a.id, a]));
---

<BaseLayout 
  title={`#${tag.name}の記事一覧`}
  description={`${tag.name}タグが付いた記事一覧です。${articles.length}件の記事があります。`}
>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <!-- ブレッドクラム -->
    <nav class="text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-gray-700">ホーム</a>
      <span class="mx-2">/</span>
      <a href="/tags" class="hover:text-gray-700">タグ</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900">#{tag.name}</span>
    </nav>
    
    <header class="mb-10">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">#{tag.name}</h1>
      <p class="text-gray-600">{articles.length}件の記事</p>
    </header>
    
    {articles.length > 0 ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {articles.map((article) => (
          <ArticleCard 
            article={article}
            category={categoryMap.get(article.categoryId)}
            author={authorMap.get(article.authorId)}
          />
        ))}
      </div>
    ) : (
      <p class="text-gray-500 text-center py-12">
        このタグにはまだ記事がありません。
      </p>
    )}
  </div>
</BaseLayout>
