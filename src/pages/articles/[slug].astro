---
import BaseLayout from '../../layouts/BaseLayout.astro';
import MagazineLayout from '../../layouts/MagazineLayout.astro';
import ArticleTracker from '../../components/ArticleTracker.astro';
import RelatedArticles from '../../components/RelatedArticles.astro';
import TagList from '../../components/TagList.astro';
import MixedContent from '../../components/MixedContent';
import SpeakerAvatar from '../../components/SpeakerAvatar';
import { 
  getPublishedArticles, 
  getArticleBySlug, 
  getRelatedArticles,
  getCategoryById,
  getAuthorById,
  getTags,
  getSiteSettings
} from '../../lib/spreadsheet';
import { parseMarkdown } from '../../lib/markdown';
import { parseContentToBlocks, hasChatContent } from '../../lib/content-parser';
import type { Article, Category, Author, Tag } from '../../types';

// 静的パスを生成
export async function getStaticPaths() {
  const articles = await getPublishedArticles();
  return articles.map((article) => ({
    params: { slug: article.slug },
  }));
}

const { slug } = Astro.params;
const article = await getArticleBySlug(slug as string);

if (!article) {
  return Astro.redirect('/404');
}

// 関連データを取得
const category = await getCategoryById(article.categoryId);
const author = await getAuthorById(article.authorId);
const allTags = await getTags();
const articleTags = allTags.filter(tag => article.tags.includes(tag.id));
const relatedArticles = await getRelatedArticles(article.id);

// サイト設定を取得
const settings = await getSiteSettings();
const siteTitle = settings.get('site_title') || 'My Media';
const theme = settings.get('theme') || 'default';
const isMagazineTheme = theme === 'magazine';

// チャット記法【speaker】が含まれているかチェック
const hasChat = hasChatContent(article.content);

// インタビュー記事かどうか（article_typeがinterviewまたはチャット記法が含まれている）
const isInterview = article.articleType === 'interview';

// 登場人物データ（intervieweesがある場合はそれを使用、なければ空配列）
const speakers = article.interviewees || [];

// コンテンツをパース（サーバーサイドで実行）
const contentBlocks = hasChat ? parseContentToBlocks(article.content) : [];
const parsedContent = !hasChat ? parseMarkdown(article.content) : '';

// 日付をフォーマット
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// マガジンテーマ用の日付フォーマット
const formatDateMagazine = (dateString: string) => {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}.${month}.${day}`;
};

// 構造化データ（JSON-LD）
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": article.title,
  "description": article.metaDescription,
  "datePublished": article.publishedAt,
  "image": article.thumbnail || undefined,
  "author": {
    "@type": "Person",
    "name": author?.name || "Unknown"
  },
  "publisher": {
    "@type": "Organization",
    "name": siteTitle
  }
};

// 記事タイプのラベル
const articleTypeLabel = isInterview ? 'インタビュー' : (hasChat ? '会話形式' : null);

// レイアウトのProps
const layoutProps = {
  title: article.title,
  description: article.metaDescription,
  ogImage: article.thumbnail,
  articleData: {
    publishedTime: article.publishedAt,
    author: author?.name,
    tags: articleTags.map(t => t.name)
  }
};
---

{isMagazineTheme ? (
  <MagazineLayout {...layoutProps}>
    <!-- 閲覧履歴トラッカー -->
    <ArticleTracker article={article} />

    <!-- 構造化データ -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <article class="article-container">
      <!-- サムネイル画像（ヒーロー） -->
      {article.thumbnail && (
        <div class="article-hero">
          <img 
            src={article.thumbnail} 
            alt={article.title}
          />
          {articleTypeLabel && (
            <span class="article-type-badge">
              {articleTypeLabel}
            </span>
          )}
        </div>
      )}

      <!-- 記事ヘッダー -->
      <header class="article-header">
        <!-- カテゴリ -->
        {category && (
          <a href={`/categories/${category.slug}`} class="article-category">
            {category.name}
          </a>
        )}
        
        <!-- タイトル -->
        <h1 class="article-title">{article.title}</h1>
        
        <!-- メタ情報 -->
        <div class="article-meta">
          {author && (
            <div class="article-author">
              {author.avatar ? (
                <img 
                  src={author.avatar} 
                  alt={author.name}
                  class="article-author-avatar"
                />
              ) : (
                <div class="article-author-placeholder">
                  {author.name.charAt(0)}
                </div>
              )}
              <div>
                <div class="article-author-name">{author.name}</div>
                <div class="article-date en-font">
                  {formatDateMagazine(article.publishedAt)}
                </div>
              </div>
            </div>
          )}
        </div>
        
        <!-- タグ -->
        {articleTags.length > 0 && (
          <div class="article-tags">
            {articleTags.map(tag => (
              <a href={`/tags/${tag.slug}`}>{tag.name}</a>
            ))}
          </div>
        )}
      </header>

      <!-- 登場人物の紹介（チャット記法がある場合） -->
      {(hasChat || isInterview) && speakers.length > 0 && (
        <section class="speakers-section">
          <h2>登場人物</h2>
          <div class="speakers-grid">
            {speakers.map((person) => (
              <div class="speaker-card">
                <SpeakerAvatar
                  client:load
                  speakerId={person.id}
                  name={person.name}
                  avatar={person.avatar}
                  size={44}
                />
                <div>
                  <div class="speaker-name">{person.name}</div>
                  {person.role && (
                    <div class="speaker-role">{person.role}</div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>
      )}
      
      <!-- 記事本文 -->
      <div class="article-content">
        {hasChat ? (
          <MixedContent
            client:load
            blocks={contentBlocks}
            speakers={speakers}
          />
        ) : (
          <div set:html={parsedContent} />
        )}
      </div>
      
      <!-- 著者情報 -->
      {author && (
        <section class="author-section">
          <h2>この記事を書いた人</h2>
          <div class="author-info">
            {author.avatar ? (
              <img 
                src={author.avatar} 
                alt={author.name}
                class="author-avatar-large"
              />
            ) : (
              <div class="author-avatar-placeholder-large">
                {author.name.charAt(0)}
              </div>
            )}
            <div class="author-details">
              <div class="author-name-large">{author.name}</div>
              <p class="author-bio">{author.profile}</p>
            </div>
          </div>
        </section>
      )}
      
      <!-- 関連記事 -->
      {relatedArticles.length > 0 && (
        <section class="related-section">
          <h2 class="en-font">Related Articles</h2>
          <div class="related-grid">
            {relatedArticles.map(related => (
              <a href={`/articles/${related.slug}`} class="related-card">
                {related.thumbnail && (
                  <img src={related.thumbnail} alt={related.title} />
                )}
                <div class="related-card-body">
                  <h3>{related.title}</h3>
                </div>
              </a>
            ))}
          </div>
        </section>
      )}
    </article>
  </MagazineLayout>
) : (
  <BaseLayout {...layoutProps}>
    <!-- 閲覧履歴トラッカー -->
    <ArticleTracker article={article} />

    <!-- 構造化データ -->
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <article class="max-w-4xl mx-auto px-4 py-12">
      <!-- サムネイル画像（ヒーロー） -->
      {article.thumbnail && (
        <div class="relative aspect-video overflow-hidden rounded-2xl mb-8 shadow-lg">
          <img 
            src={article.thumbnail} 
            alt={article.title}
            class="w-full h-full object-cover"
          />
          {articleTypeLabel && (
            <span class="absolute top-4 left-4 bg-indigo-600 text-white text-sm font-bold px-3 py-1.5 rounded-lg">
              {articleTypeLabel}
            </span>
          )}
        </div>
      )}

      <!-- 記事ヘッダー -->
      <header class="mb-10">
        <!-- カテゴリ & 記事タイプ -->
        <div class="flex items-center gap-3 mb-4">
          {category && (
            <a 
              href={`/categories/${category.slug}`}
              class="category-badge"
            >
              {category.name}
            </a>
          )}
          {!article.thumbnail && articleTypeLabel && (
            <span class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-lg">
              {articleTypeLabel}
            </span>
          )}
        </div>
        
        <!-- タイトル -->
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6 leading-tight">
          {article.title}
        </h1>
        
        <!-- メタ情報 -->
        <div class="flex flex-wrap items-center gap-4 text-gray-600 mb-6">
          {author && (
            <div class="flex items-center gap-3">
              {author.avatar ? (
                <img 
                  src={author.avatar} 
                  alt={author.name}
                  class="w-10 h-10 rounded-full object-cover"
                />
              ) : (
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                  <span class="text-gray-600 font-medium">
                    {author.name.charAt(0)}
                  </span>
                </div>
              )}
              <div>
                <div class="font-medium text-gray-900">{author.name}</div>
                <div class="text-sm text-gray-500">
                  <time datetime={article.publishedAt}>
                    {formatDate(article.publishedAt)}
                  </time>
                </div>
              </div>
            </div>
          )}
        </div>
        
        <!-- タグ -->
        {articleTags.length > 0 && (
          <TagList tags={articleTags} />
        )}
      </header>

      <!-- 登場人物の紹介（チャット記法がある場合） -->
      {(hasChat || isInterview) && speakers.length > 0 && (
        <section class="mb-10 p-6 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl">
          <h2 class="text-lg font-bold text-gray-900 mb-4">登場人物</h2>
          <div class="grid gap-4 sm:grid-cols-2">
            {speakers.map((person) => (
              <div class="flex items-center gap-3 bg-white p-3 rounded-lg">
                <SpeakerAvatar
                  client:load
                  speakerId={person.id}
                  name={person.name}
                  avatar={person.avatar}
                  size={48}
                />
                <div>
                  <div class="font-bold text-gray-900">{person.name}</div>
                  {person.role && (
                    <div class="text-sm text-gray-500">{person.role}</div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>
      )}
      
      <!-- 記事本文 -->
      {hasChat ? (
        <MixedContent
          client:load
          blocks={contentBlocks}
          speakers={speakers}
        />
      ) : (
        <div class="prose max-w-none" set:html={parsedContent} />
      )}
      
      <!-- 著者情報 -->
      {author && (
        <section class="mt-12 p-6 bg-gray-50 rounded-xl">
          <h2 class="text-lg font-bold text-gray-900 mb-3">この記事を書いた人</h2>
          <div class="flex items-start gap-4">
            {author.avatar ? (
              <img 
                src={author.avatar} 
                alt={author.name}
                class="w-16 h-16 rounded-full object-cover flex-shrink-0"
              />
            ) : (
              <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-2xl text-gray-600 font-medium">
                  {author.name.charAt(0)}
                </span>
              </div>
            )}
            <div>
              <div class="font-bold text-gray-900 mb-1">{author.name}</div>
              <p class="text-gray-600 text-sm">{author.profile}</p>
            </div>
          </div>
        </section>
      )}
      
      <!-- 関連記事 -->
      <RelatedArticles articles={relatedArticles} />
    </article>
  </BaseLayout>
)}
