---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { 
  getCategories, 
  getCategoryBySlug, 
  getArticlesByCategory,
  getAuthors
} from '../../lib/spreadsheet';

// 静的パスを生成
export async function getStaticPaths() {
  const categories = await getCategories();
  return categories.map((category) => ({
    params: { slug: category.slug },
  }));
}

const { slug } = Astro.params;
const category = await getCategoryBySlug(slug as string);

if (!category) {
  return Astro.redirect('/404');
}

const articles = await getArticlesByCategory(category.id);
const authors = await getAuthors();
const authorMap = new Map(authors.map(a => [a.id, a]));
---

<BaseLayout 
  title={`${category.name}の記事一覧`}
  description={`${category.name}カテゴリの記事一覧です。${articles.length}件の記事があります。`}
>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <!-- ブレッドクラム -->
    <nav class="text-sm text-gray-500 mb-6">
      <a href="/" class="hover:text-gray-700">ホーム</a>
      <span class="mx-2">/</span>
      <a href="/categories" class="hover:text-gray-700">カテゴリ</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900">{category.name}</span>
    </nav>
    
    <header class="mb-10">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">{category.name}</h1>
      <p class="text-gray-600">{articles.length}件の記事</p>
    </header>
    
    {articles.length > 0 ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {articles.map((article) => (
          <ArticleCard 
            article={article}
            category={category}
            author={authorMap.get(article.authorId)}
          />
        ))}
      </div>
    ) : (
      <p class="text-gray-500 text-center py-12">
        このカテゴリにはまだ記事がありません。
      </p>
    )}
  </div>
</BaseLayout>
