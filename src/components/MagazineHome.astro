---
import type { Article, Category, Author } from '../lib/spreadsheet';

interface Props {
  articles: Article[];
  categories: Category[];
  authors: Author[];
  siteTitle: string;
  headerSubtitle?: string;
}

const { articles, categories, authors, siteTitle, headerSubtitle } = Astro.props;

// カテゴリと著者のマップを作成
const categoryMap = new Map(categories.map(c => [c.id, c]));
const authorMap = new Map(authors.map(a => [a.id, a]));

// 最新記事を取得
const featuredArticle = articles[0];
const sideArticles = articles.slice(1, 4);
const gridArticles = articles.slice(4, 10);

// 日付フォーマット
function formatDate(dateStr: string | undefined): string {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');
}
---

<div class="magazine-container">
  <!-- ページヘッダー -->
  <div class="magazine-page-header">
    <h1>{siteTitle}</h1>
    {headerSubtitle && <p class="en-font">{headerSubtitle}</p>}
  </div>

  <!-- マガジントップ -->
  <div class="magazine-top">
    <!-- フィーチャー記事（左側） -->
    {featuredArticle && (
      <a href={`/articles/${featuredArticle.slug}`} class="featured-article">
        <div class="featured-img-container">
          <img 
            src={featuredArticle.thumbnail || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=800&h=450&fit=crop'} 
            alt={featuredArticle.title}
          />
        </div>
        <div class="featured-content">
          <div class="featured-meta">
            <span class="magazine-tag en-font">Feature</span>
            <span class="magazine-date en-font">{formatDate(featuredArticle.publishedAt)}</span>
          </div>
          <h2>{featuredArticle.title}</h2>
          {featuredArticle.excerpt && <p class="featured-desc">{featuredArticle.excerpt}</p>}
        </div>
      </a>
    )}

    <!-- サイドリスト（右側） -->
    <div class="side-list">
      <div class="en-font side-list-header">Recommended</div>
      {sideArticles.map((article) => (
        <a href={`/articles/${article.slug}`} class="side-article">
          <img 
            src={article.thumbnail || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=200&h=160&fit=crop'} 
            class="side-img" 
            alt={article.title}
          />
          <div class="side-content">
            <h3>{article.title}</h3>
            <span class="magazine-date en-font">{formatDate(article.publishedAt)}</span>
          </div>
        </a>
      ))}
    </div>
  </div>

  <!-- グリッド記事 -->
  {gridArticles.length > 0 && (
    <>
      <h2 class="grid-header en-font">Latest Articles</h2>
      <div class="magazine-grid">
        {gridArticles.map((article) => {
          const category = categoryMap.get(article.categoryId);
          return (
            <a href={`/articles/${article.slug}`} class="magazine-card">
              <img 
                src={article.thumbnail || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=600&h=360&fit=crop'} 
                alt={article.title}
              />
              <div class="card-body">
                <span class="magazine-tag magazine-tag-gray">{category?.name || 'Article'}</span>
                <h3>{article.title}</h3>
              </div>
            </a>
          );
        })}
      </div>
    </>
  )}
</div>

<style>
  /* マガジントップ */
  .magazine-top {
    display: grid;
    grid-template-columns: 1.8fr 1.2fr;
    gap: 2rem;
    margin-bottom: 4rem;
  }

  /* フィーチャー記事 */
  .featured-article {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    background: var(--white);
    height: 100%;
  }

  .featured-img-container {
    width: 100%;
    height: 350px;
    overflow: hidden;
  }

  .featured-article img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .featured-article:hover img { transform: scale(1.03); }

  .featured-content {
    padding: 1.5rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .featured-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.8rem;
  }

  .featured-article h2 {
    font-size: 1.8rem;
    margin: 0 0 1rem;
    line-height: 1.4;
  }
  
  .featured-desc {
    color: #666;
    margin: 0;
    font-size: 1rem;
    line-height: 1.6;
  }

  /* サイドリスト */
  .side-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .side-list-header {
    color: #999;
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
  }

  .side-article {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    text-decoration: none;
    color: var(--primary-color);
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #eee;
  }

  .side-article:last-child { border-bottom: none; }

  .side-img {
    width: 100px;
    height: 80px;
    border-radius: 8px;
    object-fit: cover;
    background: #eee;
    flex-shrink: 0;
  }

  .side-content h3 {
    margin: 0 0 0.5rem;
    font-size: 1rem;
    line-height: 1.5;
  }

  /* グリッド */
  .grid-header {
    font-size: 1.2rem;
    margin-bottom: 1.5rem;
    font-weight: 900;
  }

  .magazine-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
  }

  .magazine-card {
    background: var(--white);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s;
  }

  .magazine-card:hover { transform: translateY(-4px); }

  .magazine-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }

  .card-body { padding: 1.2rem; }

  .magazine-card h3 {
    font-size: 1.1rem;
    margin: 0.5rem 0 0;
    line-height: 1.4;
  }

  /* レスポンシブ */
  @media (max-width: 768px) {
    .magazine-top {
      grid-template-columns: 1fr;
    }
    .featured-img-container { height: 250px; }
    .featured-article h2 { font-size: 1.4rem; }
  }
</style>
