---
import type { Article, Category, Author } from '../lib/spreadsheet';

interface Props {
  articles: Article[];
  categories: Category[];
  authors: Author[];
  pageTitle: string;
  headerSubtitle?: string;
}

const { articles, categories, authors, pageTitle, headerSubtitle } = Astro.props;

// カテゴリと著者のマップを作成
const categoryMap = new Map(categories.map(c => [c.id, c]));
const authorMap = new Map(authors.map(a => [a.id, a]));

// 最新記事を取得
const featuredArticle = articles[0];
const sideArticles = articles.slice(1, 4);
const gridArticles = articles.slice(4, 10);

// 日付フォーマット
function formatDate(dateStr: string | undefined): string {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}.${month}.${day}`;
}
---

<div class="container">
  
  <div class="page-header">
    <h1>{pageTitle}</h1>
    {headerSubtitle && <p class="en-font">{headerSubtitle}</p>}
  </div>

  <div class="magazine-top">
    
    {featuredArticle && (
      <a href={`/articles/${featuredArticle.slug}`} class="featured-article">
        <div class="featured-img-container">
          <img 
            src={featuredArticle.thumbnail || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=800&h=450&fit=crop'} 
            alt={featuredArticle.title}
          />
        </div>
        <div class="featured-content">
          <div>
            <span class="magazine-tag en-font">Feature</span>
            <span class="date en-font">{formatDate(featuredArticle.publishedAt)}</span>
          </div>
          <h2>{featuredArticle.title}</h2>
          {featuredArticle.excerpt && <p class="featured-desc">{featuredArticle.excerpt}</p>}
        </div>
      </a>
    )}

    <div class="side-list">
      <div class="en-font" style="color:#999; font-size:0.8rem; margin-bottom:0.5rem;">Recommended</div>

      {sideArticles.map((article) => (
        <a href={`/articles/${article.slug}`} class="side-article">
          <img 
            src={article.thumbnail || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=200&h=160&fit=crop'} 
            class="side-img" 
            alt={article.title}
          />
          <div class="side-content">
            <h3>{article.title}</h3>
            <span class="date en-font">{formatDate(article.publishedAt)}</span>
          </div>
        </a>
      ))}
    </div>
  </div>

  {gridArticles.length > 0 && (
    <>
      <h2 class="grid-header en-font">Latest Articles</h2>
      <div class="magazine-grid">
        {gridArticles.map((article) => {
          const category = categoryMap.get(article.categoryId);
          return (
            <a href={`/articles/${article.slug}`} class="magazine-card">
              <img 
                src={article.thumbnail || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=600&h=360&fit=crop'} 
                alt={article.title}
              />
              <div class="magazine-card-body">
                <span class="magazine-tag magazine-tag-gray">{category?.name || 'Article'}</span>
                <h3>{article.title}</h3>
              </div>
            </a>
          );
        })}
      </div>
    </>
  )}

</div>
